#!/bin/bash
set -euo pipefail

# Pre-command hook for TaxJar WooCommerce Plugin CI
# Loads secrets from Chamber/SSM for test execution
# Note: Release secrets (GITHUB_TOKEN, WORDPRESS_SVN_*) are loaded in the
# environment hook so they're available to Docker plugins

CHAMBER_PATH="buildkite/taxjar-woocommerce-plugin"

# PHPUnit test steps
if [[ "$BUILDKITE_LABEL" == *"PHPUnit"* ]]; then
    echo "--- :key: Loading test secrets from Chamber"
    export TAXJAR_API_TOKEN=$(chamber read -q "$CHAMBER_PATH" taxjar_api_token || echo "")

    if [ -z "$TAXJAR_API_TOKEN" ]; then
        echo "‚ö†Ô∏è  Warning: TAXJAR_API_TOKEN not found in Chamber"
        echo "   Tests requiring API access may fail"
        echo "   Configure secret with: chamber write $CHAMBER_PATH taxjar_api_token <token>"
    else
        echo "‚úÖ TAXJAR_API_TOKEN loaded successfully"
    fi

    export BUILDKITE_ANALYTICS_TOKEN=$(chamber read -q "$CHAMBER_PATH" buildkite_analytics_token || echo "")

    if [ -z "$BUILDKITE_ANALYTICS_TOKEN" ]; then
        echo "‚ö†Ô∏è  Warning: BUILDKITE_ANALYTICS_TOKEN not found in Chamber"
        echo "   Test analytics will not be collected"
        echo "   Configure secret with: chamber write $CHAMBER_PATH buildkite_analytics_token <token>"
    else
        echo "‚úÖ BUILDKITE_ANALYTICS_TOKEN loaded successfully"
    fi
fi

# Set matrix-specific environment variables for docker-compose
# These must be set before docker-compose runs so it can select the correct image
if [ -n "${BUILDKITE_MATRIX:-}" ]; then
  # Source the single version matrix config
  # Use BUILDKITE_BUILD_CHECKOUT_PATH since $0 may be a temp wrapper script
  source "${BUILDKITE_BUILD_CHECKOUT_PATH}/.buildkite/scripts/version-matrix.sh"
  echo "üì¶ Matrix ${BUILDKITE_MATRIX}: WC ${WC_VERSION}, PHP ${PHP_VERSION}, WP ${WP_VERSION}"
fi

# Additional environment setup if needed
export BUILDKITE_PLUGIN_DOCKER_COMPOSE_BUILDKIT=1
export COMPOSE_DOCKER_CLI_BUILD=1
