#!/bin/bash
set -euo pipefail

# Post-command hook for TaxJar WooCommerce Plugin CI
# Cleanup and post-processing after command execution

# Capture WordPress container logs for PHPUnit tests
if [[ "$BUILDKITE_LABEL" == *"PHPUnit"* ]]; then
    echo "--- :docker: Capturing WordPress container logs"

    # Ensure test-results directory exists
    mkdir -p .buildkite/test-results

    # The docker-compose plugin uses 'run --rm' which removes containers after exit.
    # We need to capture logs from the named container before it's removed.
    # Container name pattern: buildkite{sanitized_job_id}_wordpress_build_{build_number}

    # Try to find the WordPress container by label
    container_id=$(docker ps -a --filter "label=com.buildkite.job_id=${BUILDKITE_JOB_ID}" \
                              --filter "label=com.buildkite.build_number=${BUILDKITE_BUILD_NUMBER}" \
                              --format "{{.ID}}" | head -1)

    if [ -n "$container_id" ]; then
        echo "Found WordPress container: $container_id"

        # Capture all container logs (stdout/stderr from Apache, PHP, WordPress)
        if docker logs "$container_id" > .buildkite/test-results/wordpress-container.log 2>&1; then
            log_size=$(wc -l < .buildkite/test-results/wordpress-container.log || echo "0")
            echo "Successfully captured container logs ($log_size lines)"

            # Show preview of interesting parts
            if [ -s .buildkite/test-results/wordpress-container.log ]; then
                echo ""
                echo "First 20 lines (startup):"
                head -n 20 .buildkite/test-results/wordpress-container.log
                echo ""
                echo "Last 20 lines (test completion):"
                tail -n 20 .buildkite/test-results/wordpress-container.log
            fi
        else
            echo "Warning: Failed to capture container logs"
            echo "No WordPress container logs captured" > .buildkite/test-results/wordpress-container.log
        fi

        # Try to copy WordPress debug.log from container if it exists
        if docker cp "$container_id":/var/www/html/wp-content/debug.log .buildkite/test-results/wordpress-debug.log 2>/dev/null; then
            echo "Successfully captured WordPress debug.log"
            debug_size=$(wc -l < .buildkite/test-results/wordpress-debug.log || echo "0")
            echo "Debug log contains $debug_size lines"
        else
            echo "No WordPress debug.log found in container"
        fi
    else
        echo "Warning: Could not find WordPress container (already removed by --rm)"
        echo "No WordPress container logs captured" > .buildkite/test-results/wordpress-container.log
    fi
fi

# Clean up any sensitive data from logs
if [ -n "${TAXJAR_API_TOKEN:-}" ]; then
    # Unset the token to prevent it from appearing in any debug output
    unset TAXJAR_API_TOKEN
fi

# If tests failed, provide helpful output
if [ "${BUILDKITE_COMMAND_EXIT_STATUS:-0}" -ne 0 ] && [[ "$BUILDKITE_LABEL" == *"PHPUnit"* ]]; then
    echo ""
    echo "--- :information_source: Test Failure Information"
    echo "To reproduce this test failure locally:"
    echo "1. Ensure Docker is running"
    echo "2. Set TAXJAR_API_TOKEN environment variable"
    echo "3. Run: docker-compose -f .buildkite/docker-compose.test.yml run wordpress"
    echo ""
    echo "For more details, check the test-results artifacts."
fi