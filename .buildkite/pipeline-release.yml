# TaxJar WooCommerce Plugin - Automated Release Pipeline
# Triggers automatically on master builds when new version detected
# Deploys to GitHub and WordPress.org
#
# Required Buildkite Secrets:
#   - WORDPRESS_SVN_USERNAME: WordPress.org account username
#   - WORDPRESS_SVN_PASSWORD: WordPress.org account password
#   - GITHUB_TOKEN: GitHub personal access token for gh CLI

env:
  # These will be set by detect-version script
  VERSION: ""

steps:
  # Stage 1: Detect if there's a new version to release
  - label: ":mag: Detect New Version"
    key: "detect-version"
    command: |
      .buildkite/scripts/release/detect-version.sh

      # Check if script set SKIP_RELEASE meta-data
      if buildkite-agent meta-data exists "SKIP_RELEASE" 2>/dev/null; then
        echo "+++ Version already deployed - skipping release"
        buildkite-agent annotate "Version already exists on WordPress.org - skipping release" --style "info" --context "version-check"

        # Upload a minimal success pipeline
        buildkite-agent pipeline upload <<YAML
      steps:
        - label: ":white_check_mark: Release Already Deployed"
          command: echo "Version already exists on WordPress.org"
      YAML
        exit 0
      fi

      echo "+++ New version detected - proceeding with release"
    agents:
      queue: "docker"
    timeout_in_minutes: 5

  - wait

  # Stage 2: Run full test suite on master
  - label: ":test_tube: Full Test Suite"
    key: "test-suite"
    depends_on: "detect-version"
    command: |
      echo "+++ Running full test suite on master"
      buildkite-agent pipeline upload .buildkite/pipeline.yml
    agents:
      queue: "docker"
    timeout_in_minutes: 60

  - wait

  # Stage 3: Create GitHub release (automatically creates git tag)
  - label: ":github: Create GitHub Release"
    key: "github-release"
    depends_on: "test-suite"
    command: |
      # Ensure VERSION is available
      if [[ -z "$VERSION" ]]; then
        export VERSION=$(buildkite-agent meta-data get "release-version")
      fi
      .buildkite/scripts/release/github-release.sh
    agents:
      queue: "docker"
    timeout_in_minutes: 10

  # Stage 4: Deploy to WordPress.org SVN
  - label: ":package: Deploy to WordPress.org"
    key: "svn-deploy"
    depends_on: "github-release"
    command: |
      # Ensure VERSION is available
      if [[ -z "$VERSION" ]]; then
        export VERSION=$(buildkite-agent meta-data get "release-version")
      fi
      .buildkite/scripts/release/svn-deploy.sh
    agents:
      queue: "docker"
    timeout_in_minutes: 15

  # Stage 5: Verify and notify
  - label: ":mag: Verify Release"
    key: "verify"
    depends_on: "svn-deploy"
    command: |
      # Ensure VERSION is available
      if [[ -z "$VERSION" ]]; then
        export VERSION=$(buildkite-agent meta-data get "release-version")
      fi

      echo "--- Waiting for WordPress.org to update"
      sleep 30

      echo "--- Checking WordPress.org"
      PLUGIN_URL="https://wordpress.org/plugins/taxjar-simplified-taxes-for-woocommerce/"

      if curl -sf "$PLUGIN_URL" | grep -q "$VERSION"; then
        echo "+++ ✓ Version $VERSION is live on WordPress.org"
      else
        echo "⚠️  Version not yet visible on WordPress.org (may take a few minutes)"
      fi

      echo ""
      echo "+++ Release Complete"
      echo "Version: $VERSION"
      echo "GitHub: https://github.com/taxjar/taxjar-woocommerce-plugin/releases/tag/$VERSION"
      echo "WordPress.org: $PLUGIN_URL"
    agents:
      queue: "docker"
    timeout_in_minutes: 5
